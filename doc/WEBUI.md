# Web UI

The web UI serves the same purpose as the CLI, namely perform device and
key management operations for a fleet of remote devices.

Each client devices has an identifier and a secret key, shared with the
key management server (C2). In addition, each client is associated with
one or more topics, where each topic has a name and a dedicated key.

Keys are 32-byte and encoded in hexadecimal in HTTP requests. Of course
these requests will be sent over TLS.

Two types of users are considered: standard user and admin.
The operations to be performed are essentially CRUD operations on a
database of keys, where each client name and each topic name is
associated with a unique key.

## Standard user operations

A standard user should be able to perform the following operations:

### Client management operations

* **Register a new client**, by entering its name (string) and
  optionally a key. If no key is provided, one is generated using a cryptographic
  PRNG available from the browser (recommended:
  [`Crypto.getRandomValues()`](https://developer.mozilla.org/en-US/docs/Web/API/Crypto/getRandomValues)).

* **Delete a client**, by entering its identifie

* **Update the key of a client**, by entering the client identifier and
  optionally a key. If no key is provided then one is generated.

HTTP requests used for these operations are respectively

* POST /e4/client/{id}/key/{key}: `new_client(id, key)`

* DELETE /e4/client/{id}: `remove_client(id)`

* PATCH /e4/client/{id}/: `new_client_key(id)` 

These operations only modify the server database, and do not trigger a
control message sent to a remote client.

## Topic management operations

* **Register a new topic**, by entering the topic name. A key is
  automatically generated by the client.

* **Delete a topic** by entering the topic name.

HTTP requests used for these operations are respectively:

* POST /e4/topic/{topic}: `new_topic(topic)`

* DELETE /e4/topic/{topic}: `remove_topic(topic)` 

These operations only modify the server database, and do not trigger a
control message sent to a remote client.

## Topic/client association management

* **Associate a client to a topic**

* **Remove a topic associated to a client**

* **Remove all topics associated to a client**

HTTP requests used for these operations are respectively:

* PUT /e4/client/{id}/topic/{topic}: `new_topic_client(id, topic)`

* DELETE /e4/client/{id}/topic/{topic}: `remove_topic_client(id, topic)`

* PUT /e4/client/{id}: `reset_client(id)` 

## Admin operations

An admin should be able to manage users of the application, in addition
to the standard user operations.

## File-based mode

As an alternative to manual operations, a user should be able to upload
a file with a list of operations (and their arguments), such that each
line corresponds to an operation.

## UI concerns

The UI should show the following visual elements (not necessarily on the
same page)

* Dashboard showing metrics (number of clients in the DB, number of
  topics, number of clients with no topic key, 

* A log of the most recent operations performed.

* Tables listing clients and their associated topics (and the other way
  around), searchable by name, sortable by number of topics, etc. With a
  button or other visual element to delete an entry, add topics, etc.

## Other requirements

The application must be served over TLS properly configured, and should
connect to the C2 service using TLS as well.

The app should be optimized for desktop browsers but be compatible with
mobile browsers.


## REST API

In the following API, `topic` is any acceptable MQTT topic. Special characters 
in this topic will be url-encoded. `id` is a 32-character hexadecimal value that 
identifies the client. `key` is a 64-character hexadecimal value that identifies 
the key.

`offset` and `count` are integers. 

E4 C2 API:

* POST /e4/client/{id}/key/{key}: `new_client(id, key)`

* DELETE /e4/client/{id}: `remove_client(id)`

* PUT /e4/client/{id}/topic/{topic}: `new_topic_client(id, topic)`

* DELETE /e4/client/{id}/topic/{topic}: `remove_topic_client(id, topic)`

* PUT /e4/client/{id}: `reset_client(id)` 

* POST /e4/topic/{topic}: `new_topic(topic)`

* DELETE /e4/topic/{topic}: `remove_topic(topic)` 

* PATCH /e4/client/{id}/: `new_client_key(id)` 

* GET /e4/topic/: lists of all topics. This API may be unsafe.

* GET /e4/client/: lists all client ids. This API may be unsafe.

* GET /e4/client/{id}: lists the topics support by id

* GET /e4/topic/{topic}/clients/count - lists the number of clients with 
  the topic key for a specific topic.

* GET /e4/topic/{topic}/client/{offset}/{count} - retrieves clients that 
  have access to the given topic, starting at the offset given by offset and 
  retrieving count number of such devices, to enable paginated retrieval 
  of clients.

* GET /e4/client/{id}/topics/count - returns the number of topics to which a 
  given client identified by `id` is subscribed to and have access to the 
  topic key.

* GET /e4/client/{id}/topics/{offset}/{count} - returns the topics associated 
  with a given client identified by `id`, starting from offset and returning 
  count in number.

## User stories

The following are a series of user stores that specify how the user should 
experience the product.

 1. The User has an embedded device, which they describe with a known identifier 
    they may use internally. An example might be "Sensor-CH-VD-1003-ID-200". 
    They wish to enroll this device in the C2.

 2. The User has a number of enrolled devices in the C2. They wish to create a 
    group communication channel for one or more of these devices with a given 
    topic name and add the device to that topic.

 3. The User has a topic and a device name. They want to find out what topics 
    that device is subscribed to, so they can check if it is in the topic 
    name they have. Having done this, they then wish to find out what other 
    devices share that topic (regardless of the outcome of the first query).

 4. The user has decommisioned a device. They wish to remove it from the C2 
    using the webui.

 5. The user has decided that a topic may no longer be used and are removing 
    it. They remove it from the C2.

 6. The user wishes to reset a device. 

 7. The user wishes to alter the key for a client.
